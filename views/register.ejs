<!DOCTYPE html>
<html lang="de" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrierung - Doktorum nerede</title>
    <link href="/css/output.css" rel="stylesheet">
</head>
<body class="h-full">
    <div class="flex min-h-full flex-col justify-center py-12 sm:px-6 lg:px-8">
        <div class="sm:mx-auto sm:w-full sm:max-w-md">
            <a href="/" class="text-center text-2xl font-bold leading-9 tracking-tight text-indigo-600">
                Doktorum nerede
            </a>
            <h2 class="mt-6 text-center text-2xl font-bold leading-9 tracking-tight text-gray-900">
                Als Arzt registrieren
            </h2>
        </div>

        <div class="mt-10 sm:mx-auto sm:w-full sm:max-w-[480px]">
            <div class="bg-white px-6 py-12 shadow sm:rounded-lg sm:px-12">
                <div class="mb-6 text-sm text-gray-600">
                    <p>Sehr geehrte Kollegin, sehr geehrter Kollege,</p>
                    <p class="mt-2">nach der Registrierung können Sie auf Ihrer Profilseite weitere Informationen bearbeiten und Ihr Foto hochladen.</p>
                </div>

                <% if (error) { %>
                    <div class="mb-6 rounded-md bg-red-50 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800"><%= error %></h3>
                            </div>
                        </div>
                    </div>
                <% } %>

                <form class="space-y-6" action="/register" method="POST">
                    <div>
                        <label for="email" class="block text-sm font-medium leading-6 text-gray-900">E-Mail *</label>
                        <div class="mt-2">
                            <input type="email" id="email" name="email" required
                                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                        </div>
                    </div>

                    <div>
                        <label for="password" class="block text-sm font-medium leading-6 text-gray-900">Passwort *</label>
                        <div class="mt-2">
                            <input type="password" id="password" name="password" required
                                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                        </div>
                    </div>

                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium leading-6 text-gray-900">Passwort wiederholen *</label>
                        <div class="mt-2">
                            <input type="password" id="confirmPassword" name="confirmPassword" required
                                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                        </div>
                    </div>

                    <div>
                        <label for="title" class="block text-sm font-medium leading-6 text-gray-900">Anrede *</label>
                        <div class="mt-2">
                            <select id="title" name="title" required
                                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                <option value="">Bitte wählen</option>
                                <option value="Herr">Herr</option>
                                <option value="Frau">Frau</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="academicTitle" class="block text-sm font-medium leading-6 text-gray-900">Akademischer Titel *</label>
                        <div class="mt-2">
                            <input type="text" id="academicTitle" name="academicTitle" required
                                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                        </div>
                    </div>

                    <div>
                        <label for="firstName" class="block text-sm font-medium leading-6 text-gray-900">Vorname *</label>
                        <div class="mt-2">
                            <input type="text" id="firstName" name="firstName" required
                                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                        </div>
                    </div>

                    <div>
                        <label for="lastName" class="block text-sm font-medium leading-6 text-gray-900">Nachname *</label>
                        <div class="mt-2">
                            <input type="text" id="lastName" name="lastName" required
                                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                        </div>
                    </div>

                    <div>
                        <label for="mainSpecialty" class="block text-sm font-medium leading-6 text-gray-900">Fachgebiet *</label>
                        <div class="mt-2">
                            <select id="mainSpecialty" name="mainSpecialty" required
                                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                <option value="">Bitte wählen</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="address" class="block text-sm font-medium leading-6 text-gray-900">Adresse</label>
                        <div class="mt-2">
                            <input type="text" id="address" name="address" placeholder="Beginnen Sie mit der Eingabe Ihrer Adresse..."
                                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                        </div>
                        <p class="mt-1 text-sm text-gray-500">Wählen Sie eine Adresse aus den Vorschlägen für eine genaue Validierung</p>
                    </div>

                    <div class="hidden">
                        <label for="street" class="block text-sm font-medium leading-6 text-gray-900">Straße und Hausnummer</label>
                        <div class="mt-2">
                            <input type="text" id="street" name="street"
                                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                        </div>
                    </div>

                    <div>
                        <label for="addressLine2" class="block text-sm font-medium leading-6 text-gray-900">Adresszusatz (optional)</label>
                        <div class="mt-2">
                            <input type="text" id="addressLine2" name="addressLine2" 
                                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"
                                placeholder="z.B. Stiege, Tür, Stockwerk, Gebäude">
                        </div>
                        <p class="mt-1 text-sm text-gray-500">Zusätzliche Informationen zur Adresse, die nicht von Google Maps erfasst werden</p>
                    </div>

                    <div class="hidden">
                        <label for="zipCode" class="block text-sm font-medium leading-6 text-gray-900">PLZ</label>
                        <div class="mt-2">
                            <input type="text" id="zipCode" name="zipCode" 
                                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                        </div>
                    </div>

                    <div class="hidden">
                        <label for="city" class="block text-sm font-medium leading-6 text-gray-900">Stadt</label>
                        <div class="mt-2">
                            <input type="text" id="city" name="city" 
                                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                        </div>
                    </div>

                    <div>
                        <label for="phone" class="block text-sm font-medium leading-6 text-gray-900">Telefon *</label>
                        <div class="mt-2">
                            <input type="tel" id="phone" name="phone" required
                                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                        </div>
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" id="showEmail" name="showEmail" value="true"
                            class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600">
                        <label for="showEmail" class="ml-3 block text-sm leading-6 text-gray-900">
                            E-Mail-Adresse öffentlich anzeigen
                        </label>
                    </div>

                    <div class="text-sm text-gray-500">
                        * Pflichtfelder
                    </div>

                    <div>
                        <button type="submit" 
                            class="flex w-full justify-center rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-semibold leading-6 text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                            Registrieren
                        </button>
                    </div>

                    <p class="text-center text-sm text-gray-500">
                        Bereits registriert? 
                        <a href="/login" class="font-semibold leading-6 text-indigo-600 hover:text-indigo-500">
                            Hier anmelden
                        </a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Variablen aus dem Server
        const serverSpecialties = <%- JSON.stringify(specialties) %>;
        
        // Formular-Validierung
        document.addEventListener('DOMContentLoaded', function() {
            const titleSelect = document.getElementById('title');
            const mainSpecialtySelect = document.getElementById('mainSpecialty');
            
            // Befülle das Fachgebiets-Dropdown basierend auf der ausgewählten Anrede
            function updateSpecialties() {
                const gender = titleSelect.value === 'Frau' ? 'female' : 'male';
                
                // Lösche bestehende Optionen
                mainSpecialtySelect.innerHTML = '<option value="">Bitte wählen</option>';
                
                // Füge alle verfügbaren Fachgebiete hinzu
                Object.entries(serverSpecialties[gender]).forEach(([key, value]) => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = value;
                    mainSpecialtySelect.appendChild(option);
                });
            }
            
            // Initialer Aufruf und Eventlistener
            if (titleSelect) {
                updateSpecialties();
                titleSelect.addEventListener('change', updateSpecialties);
            }
        });

        // Google Maps Places API für Adressvalidierung
        function initAutocomplete() {
            try {
                // Initialisiere den Autocomplete-Service mit verbesserter Konfiguration
                const autocompleteOptions = {
                    componentRestrictions: { country: ['at'] }, // Einschränkung auf Österreich
                    fields: ['address_component', 'geometry', 'name'],
                    types: ['address'],
                    minLength: 3 // Minimum 3 Zeichen
                };
                
                const autocomplete = new google.maps.places.Autocomplete(
                    document.getElementById('address'),
                    autocompleteOptions
                );
                
                // Listener für die Adressauswahl
                autocomplete.addListener('place_changed', function() {
                    try {
                        const place = autocomplete.getPlace();
                        
                        if (!place || !place.geometry) {
                            // Benutzer hat keine Adresse aus der Vorschlagsliste ausgewählt
                            document.getElementById('address').classList.add('border-red-500');
                            return;
                        }
                        
                        document.getElementById('address').classList.remove('border-red-500');
                        
                        // Extrahiere Adresskomponenten
                        let street = '';
                        let streetNumber = '';
                        let zipCode = '';
                        let city = '';
                        
                        for (const component of place.address_components || []) {
                            const componentType = component.types[0];

                            switch (componentType) {
                                case 'route':
                                    street = component.long_name;
                                    break;
                                case 'street_number':
                                    streetNumber = component.long_name;
                                    break;
                                case 'postal_code':
                                    zipCode = component.long_name;
                                    break;
                                case 'locality':
                                    city = component.long_name;
                                    break;
                            }
                        }
                        
                        // Befülle die verborgenen Felder
                        document.getElementById('street').value = street + (streetNumber ? ' ' + streetNumber : '');
                        document.getElementById('zipCode').value = zipCode;
                        document.getElementById('city').value = city;
                        
                        // Validiere, ob alle erforderlichen Informationen vorhanden sind
                        if (!street || !zipCode || !city) {
                            console.warn('Unvollständige Adressdaten:', place);
                            alert('Bitte wählen Sie eine vollständige Adresse mit Straße, PLZ und Stadt');
                        }
                    } catch (error) {
                        console.error('Fehler bei der Verarbeitung der Adresse:', error);
                        // Fallback: Formular kann trotzdem abgesendet werden
                        document.getElementById('street').value = document.getElementById('address').value;
                    }
                });
                
                // Eingabefeld-Event für manuelle Eingabe ohne Auswahl
                document.getElementById('address').addEventListener('blur', function() {
                    setTimeout(() => {
                        const addressField = document.getElementById('address');
                        const streetField = document.getElementById('street');
                        // Wenn keine Straße gesetzt wurde, aber eine Adresse eingegeben wurde
                        if (!streetField.value && addressField.value.trim().length > 0) {
                            // Manuell eingegebene Adresse als Straße übernehmen (Fallback)
                            streetField.value = addressField.value;
                            console.log('Manuelle Adresseingabe übernommen:', addressField.value);
                        }
                    }, 300);
                });
                
                console.log('Google Maps Autocomplete erfolgreich initialisiert');
            } catch (error) {
                console.error('Fehler bei der Initialisierung von Google Maps Autocomplete:', error);
                // Fallback: Adressfeld als normales Eingabefeld verwenden
                document.getElementById('address').addEventListener('blur', function() {
                    document.getElementById('street').value = document.getElementById('address').value;
                });
            }
        }

        // Alternative Initialisierung falls Google Maps API nicht lädt
        window.gm_authFailure = function() {
            console.error('Google Maps Authentifizierungsfehler');
            document.getElementById('address').placeholder = 'Bitte geben Sie Ihre vollständige Adresse ein';
            document.getElementById('address').addEventListener('blur', function() {
                const parts = this.value.split(',');
                if (parts.length > 1) {
                    document.getElementById('street').value = parts[0].trim();
                    const cityParts = parts[1].trim().split(' ');
                    if (cityParts.length > 1) {
                        document.getElementById('zipCode').value = cityParts[0].trim();
                        document.getElementById('city').value = cityParts.slice(1).join(' ').trim();
                    } else {
                        document.getElementById('city').value = cityParts[0].trim();
                    }
                } else {
                    document.getElementById('street').value = this.value;
                }
            });
        };

        // Falls die API nach 5 Sekunden nicht geladen ist, Fallback aktivieren
        setTimeout(function() {
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                gm_authFailure();
            }
        }, 5000);

        // Vor dem Absenden des Formulars: Adressvalidierung mit Fallback
        document.querySelector('form').addEventListener('submit', function(e) {
            const street = document.getElementById('street').value;
            const zipCode = document.getElementById('zipCode').value;
            const city = document.getElementById('city').value;
            const addressField = document.getElementById('address');
            
            // Wenn keine Straße, aber Adresse eingegeben wurde, Adresse als Straße verwenden
            if (!street && addressField.value.trim()) {
                document.getElementById('street').value = addressField.value;
            }
            
            // Adresse ist jetzt kein Pflichtfeld mehr, also muss das Formular immer gesendet werden können
        });
    </script>
    
    <!-- Google Maps Places API laden mit Retry-Option und Timeout -->
    <script>
        let retryCount = 0;
        const maxRetries = 2;
        
        function loadGoogleMapsAPI() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyBdLX-Lh95i1L-2-ed-FLzQC0_m8pE&libraries=places&callback=initAutocomplete&v=weekly`;
            script.async = true;
            script.defer = true;
            
            script.onerror = function() {
                console.error('Fehler beim Laden der Google Maps API');
                if (retryCount < maxRetries) {
                    retryCount++;
                    console.log(`Versuche Google Maps API erneut zu laden (${retryCount}/${maxRetries})`);
                    setTimeout(loadGoogleMapsAPI, 1000);
                } else {
                    console.error('Maximale Anzahl von Versuchen erreicht');
                    gm_authFailure();
                }
            };
            
            document.head.appendChild(script);
        }
        
        loadGoogleMapsAPI();
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil bearbeiten - Doktorum nerede</title>
    <link href="/css/output.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="min-h-screen p-6">
        <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50 p-4 mb-6 rounded-lg">
            <div class="flex justify-between items-center">
                <a href="/profile" class="text-blue-600 hover:text-blue-900">← Zurück zum Profil</a>
                <form action="/logout" method="POST" class="inline">
                    <button type="submit" class="text-red-600 hover:text-red-900">Abmelden</button>
                </form>
            </div>
        </nav>

        <div class="max-w-3xl mx-auto">
            <div class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50 rounded-2xl p-6 hover:shadow-lg transition-all duration-200 ease-in-out overflow-hidden">
                <div class="p-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6">Profil bearbeiten</h1>

                    <% if (success) { %>
                        <div class="mb-6 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
                            <strong class="font-bold">Erfolg!</strong>
                            <span class="block sm:inline">Ihre Änderungen wurden erfolgreich gespeichert.</span>
                        </div>
                    <% } %>

                    <% if (error) { %>
                        <div class="mb-6 rounded-lg bg-red-50 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-semibold text-red-800"><%= error %></h3>
                                </div>
                            </div>
                        </div>
                    <% } %>

                    <% if (!doctor.isApproved) { %>
                        <div class="mb-6 bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded relative" role="alert">
                            <strong class="font-bold">Hinweis:</strong>
                            <span class="block sm:inline">Ihr Profil muss erst von einem Administrator freigegeben werden, bevor Sie Änderungen vornehmen können.</span>
                        </div>
                    <% } %>

                    <% if (errors && errors.length > 0) { %>
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                            <strong class="font-bold">Fehler:</strong>
                            <span class="block sm:inline"><%= errors.join(', ') %></span>
                        </div>
                    <% } %>

                    <form action="/profile/edit" method="POST" enctype="multipart/form-data" class="space-y-6">
                        <!-- Hidden title field for backend compatibility -->
                        <input type="hidden" id="title" name="title" value="<%= doctor.title || 'Herr' %>">

                        <div>
                            <label for="academicTitle" class="block text-sm font-semibold text-gray-800 mb-2 ">Akademischer Titel *</label>
                            <div class="mt-2">
                                <input type="text" id="academicTitle" name="academicTitle" value="<%= doctor.academicTitle %>" required
                                    class="block w-full rounded-lg border border-gray-300 rounded-lg p-3 text-gray-900 placeholder:text-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 ease-in-out sm:text-sm sm:leading-6">
                            </div>
                        </div>

                        <div>
                            <label for="firstName" class="block text-sm font-semibold text-gray-800 mb-2 ">Vorname *</label>
                            <div class="mt-2">
                                <input type="text" id="firstName" name="firstName" value="<%= doctor.firstName %>" required autocomplete="given-name"
                                    class="block w-full rounded-lg border border-gray-300 rounded-lg p-3 text-gray-900 placeholder:text-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 ease-in-out sm:text-sm sm:leading-6">
                            </div>
                        </div>

                        <div>
                            <label for="lastName" class="block text-sm font-semibold text-gray-800 mb-2 ">Nachname *</label>
                            <div class="mt-2">
                                <input type="text" id="lastName" name="lastName" value="<%= doctor.lastName %>" required autocomplete="family-name"
                                    class="block w-full rounded-lg border border-gray-300 rounded-lg p-3 text-gray-900 placeholder:text-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 ease-in-out sm:text-sm sm:leading-6">
                            </div>
                        </div>

                        <div>
                            <label for="mainSpecialty" class="block text-sm font-semibold text-gray-800 mb-2 ">Hauptfachgebiet *</label>
                            <div class="mt-2">
                                <select id="mainSpecialty" name="mainSpecialty" required
                                    class="block w-full rounded-lg border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 ease-in-out sm:text-sm sm:leading-6">
                                    <option value="">Bitte wählen</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label for="secondarySpecialty" class="block text-sm font-semibold text-gray-800 mb-2 ">Zusätzliches Fachgebiet</label>
                            <div class="mt-2">
                                <select id="secondarySpecialty" name="secondarySpecialty"
                                    class="block w-full rounded-lg border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 ease-in-out sm:text-sm sm:leading-6">
                                    <option value="">Bitte wählen</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label for="street" class="block text-sm font-semibold text-gray-800 mb-2 ">Straße und Hausnummer</label>
                            <div class="mt-2">
                                <input type="text" id="street" name="street" value="<%= doctor.street %>" autocomplete="street-address"
                                    class="block w-full rounded-lg border border-gray-300 rounded-lg p-3 text-gray-900 placeholder:text-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 ease-in-out sm:text-sm sm:leading-6">
                            </div>
                        </div>

                        <div>
                            <label for="zipCode" class="block text-sm font-semibold text-gray-800 mb-2 ">PLZ *</label>
                            <div class="mt-2">
                                <input type="text" id="zipCode" name="zipCode" value="<%= doctor.zipCode %>" required autocomplete="postal-code"
                                    class="block w-full rounded-lg border border-gray-300 rounded-lg p-3 text-gray-900 placeholder:text-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 ease-in-out sm:text-sm sm:leading-6">
                            </div>
                        </div>

                        <div>
                            <label for="city" class="block text-sm font-semibold text-gray-800 mb-2 ">Stadt *</label>
                            <div class="mt-2">
                                <input type="text" id="city" name="city" value="<%= doctor.city %>" required autocomplete="address-level2"
                                    class="block w-full rounded-lg border border-gray-300 rounded-lg p-3 text-gray-900 placeholder:text-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 ease-in-out sm:text-sm sm:leading-6">
                            </div>
                        </div>

                        <div>
                            <label for="phone" class="block text-sm font-semibold text-gray-800 mb-2 ">Telefon *</label>
                            <div class="mt-2">
                                <input type="tel" id="phone" name="phone" value="<%= doctor.phone %>" required autocomplete="tel"
                                    class="block w-full rounded-lg border border-gray-300 rounded-lg p-3 text-gray-900 placeholder:text-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 ease-in-out sm:text-sm sm:leading-6">
                            </div>
                        </div>

                        <div>
                            <label for="website" class="block text-sm font-semibold text-gray-800 mb-2 ">Website</label>
                            <div class="mt-2">
                                <input type="url" id="website" name="website" value="<%= doctor.website %>"
                                    class="block w-full rounded-lg border border-gray-300 rounded-lg p-3 text-gray-900 placeholder:text-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 ease-in-out sm:text-sm sm:leading-6">
                            </div>
                        </div>

                        <div>
                            <label for="additionalInfo" class="block text-sm font-semibold text-gray-800 mb-2 ">Zusätzliche Informationen</label>
                            <div class="mt-2">
                                <textarea id="additionalInfo" name="additionalInfo" rows="4"
                                    class="block w-full rounded-lg border border-gray-300 rounded-lg p-3 text-gray-900 placeholder:text-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 ease-in-out sm:text-sm sm:leading-6"><%= doctor.additionalInfo %></textarea>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-800 mb-2 ">Kassenverträge</label>
                            <div class="mt-2 space-y-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="noContract" name="noContract" value="true" <%= doctor.insurance?.noContract ? 'checked' : '' %>
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="noContract" class="ml-3 block text-sm ">
                                        Nur Privatpatienten
                                    </label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="oegk" name="insurance_oegk" value="true" <%= doctor.insurance?.oegk ? 'checked' : '' %>
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="oegk" class="ml-3 block text-sm ">
                                        ÖGK
                                    </label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="svs" name="insurance_svs" value="true" <%= doctor.insurance?.svs ? 'checked' : '' %>
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="svs" class="ml-3 block text-sm ">
                                        SVS
                                    </label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="bvaeb" name="insurance_bvaeb" value="true" <%= doctor.insurance?.bvaeb ? 'checked' : '' %>
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="bvaeb" class="ml-3 block text-sm ">
                                        BVAEB
                                    </label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="kfa" name="insurance_kfa" value="true" <%= doctor.insurance?.kfa ? 'checked' : '' %>
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <label for="kfa" class="ml-3 block text-sm ">
                                        KFA
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="photo" class="block text-sm font-semibold text-gray-800 mb-2 ">Profilfoto</label>
                            <p class="mt-1 text-sm text-gray-500">Laden Sie hier Ihr Profilfoto hoch.</p>
                            <div class="mt-2">
                                <input type="file" id="photo" name="photo" accept="image/*"
                                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:bg-green-50 rounded-xl border border-green-200 file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-blue-600 hover:file:bg-indigo-100">
                            </div>
                            <% if (doctor.photo) { %>
                                <div class="mt-2">
                                    <img src="/uploads/<%= doctor.photo %>" alt="Aktuelles Profilfoto" class="w-32 h-32 object-cover rounded-lg">
                                </div>
                            <% } %>
                        </div>

                        <div>
                            <label for="galleryPhotos" class="block text-sm font-semibold text-gray-800 mb-2 ">Ordinationsfotos</label>
                            <p class="mt-1 text-sm text-gray-500">Hier können Sie 2 Fotos von Ihrer Ordination hochladen.</p>
                            <div class="mt-2">
                                <input type="file" id="galleryPhotos" name="galleryPhotos" accept="image/*" multiple
                                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:bg-green-50 rounded-xl border border-green-200 file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-blue-600 hover:file:bg-indigo-100">
                            </div>
                            <% if (doctor.galleryPhotos && doctor.galleryPhotos.length > 0) { %>
                                <div class="mt-4 grid grid-cols-2 gap-4">
                                    <% doctor.galleryPhotos.forEach(photo => { %>
                                        <div class="relative">
                                            <img src="/uploads/<%= photo %>" alt="Ordinationsfoto" class="w-full h-auto rounded-lg">
                                            <form action="/profile/gallery-photo/<%= photo %>" method="POST" style="display: inline;">
                                                <input type="hidden" name="_method" value="DELETE">
                                                <button type="submit" 
                                                    class="absolute top-2 right-2 bg-red-600 text-white rounded-full p-1 hover:bg-red-700"
                                                    onclick="return confirm('Möchten Sie dieses Foto wirklich löschen?')">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </form>
                                        </div>
                                    <% }); %>
                                </div>
                            <% } %>
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="showEmail" name="showEmail" value="true" <%= doctor.showEmail ? 'checked' : '' %>
                                class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="showEmail" class="ml-3 block text-sm ">
                                E-Mail-Adresse öffentlich anzeigen
                            </label>
                        </div>

                        <div class="text-sm text-gray-500">
                            * Pflichtfelder
                        </div>

                        <div>
                            <button type="submit" 
                                class="flex w-full justify-center rounded-lg bg-blue-600 px-3 p-3 text-sm font-semibold leading-6 text-white shadow-md hover:bg-blue-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600">
                                Änderungen speichern
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Daten für JavaScript -->
    <div id="specialties-data" 
        data-specialties="<%= JSON.stringify(specialties) %>"
        data-main-specialty="<%= doctor.specialties && doctor.specialties[0] ? doctor.specialties[0] : '' %>" 
        data-secondary-specialty="<%= doctor.specialties && doctor.specialties[1] ? doctor.specialties[1] : '' %>"
        style="display:none;">
    </div>

    <script>
        // CRITICAL: Immediate log to verify script is loading
        console.log('========================================');
        console.log('[EDIT-PROFILE] Script loaded - waiting for DOMContentLoaded...');
        console.log('[EDIT-PROFILE] Current URL:', window.location.href);
        console.log('[EDIT-PROFILE] Document title:', document.title);
        console.log('========================================');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('========================================');
            console.log('[EDIT-PROFILE] DOMContentLoaded fired - initializing form handlers...');
            console.log('========================================');
            const titleHidden = document.getElementById('title');
            const mainSpecialtySelect = document.getElementById('mainSpecialty');
            const secondarySpecialtySelect = document.getElementById('secondarySpecialty');
            const noContractCheckbox = document.getElementById('noContract');
            const insuranceCheckboxes = ['oegk', 'svs', 'bvaeb', 'kfa'].map(id => document.getElementById(id));
            
            // Daten aus HTML-Attributen laden
            const specialtiesData = document.getElementById('specialties-data');
            const specialties = JSON.parse(specialtiesData.dataset.specialties);
            const currentMainSpecialty = specialtiesData.dataset.mainSpecialty;
            const currentSecondarySpecialty = specialtiesData.dataset.secondarySpecialty;

            mainSpecialtySelect.innerHTML = '<option value="">Bitte wählen</option>';
            secondarySpecialtySelect.innerHTML = '<option value="">Bitte wählen</option>';

            // Use existing title from doctor data or default to 'Herr'
            const currentTitle = titleHidden ? titleHidden.value : '<%= doctor.title || 'Herr' %>';
            const genderKey = currentTitle === 'Frau' ? 'female' : 'male';

            // Lade alle verfügbaren Fachgebiete aus der vom Server gesendeten Spezialitätenliste
            Object.entries(specialties[genderKey]).forEach(([key, value]) => {
                mainSpecialtySelect.innerHTML += `<option value="${key}" ${key === currentMainSpecialty ? 'selected' : ''}>${value}</option>`;
                secondarySpecialtySelect.innerHTML += `<option value="${key}" ${key === currentSecondarySpecialty ? 'selected' : ''}>${value}</option>`;
            });

            // Kassenverträge Logik
            noContractCheckbox.addEventListener('change', function() {
                insuranceCheckboxes.forEach(checkbox => {
                    checkbox.disabled = this.checked;
                    if (this.checked) checkbox.checked = false;
                });
            });

            insuranceCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) noContractCheckbox.checked = false;
                });
            });

            // Initial Status setzen
            if (noContractCheckbox.checked) {
                insuranceCheckboxes.forEach(checkbox => checkbox.disabled = true);
            }
            
            // Prevent form from submitting normally - we'll handle it with fetch
            const form = document.querySelector('form[action="/profile/edit"]');
            if (form) {
                console.log('[CLIENT] Form found, attaching submit handler...');
                form.addEventListener('submit', function(e) {
                    // If this is triggered by file input change, let the file handler manage it
                    // Otherwise prevent default to avoid double submission
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.type === 'file') {
                        // File input change handler will take care of it
                        return;
                    }
                    // For regular form submission, allow it (but file uploads should use fetch)
                    const fileInputs = form.querySelectorAll('input[type="file"]');
                    let hasSelectedFile = false;
                    fileInputs.forEach(input => {
                        if (input.files && input.files.length > 0) {
                            hasSelectedFile = true;
                        }
                    });
                    if (hasSelectedFile) {
                        // File upload in progress - prevent normal submission
                        e.preventDefault();
                        console.log('[CLIENT] Prevented form default submission - file upload detected');
                    }
                });
            } else {
                console.error('[CLIENT] Form not found!');
            }
            
            // Automatisches Übermitteln des Formulars beim Ändern des Profilfotos
            console.log('[CLIENT] Looking for photo input...');
            const photoInput = document.getElementById('photo');
            if (photoInput) {
                console.log('[CLIENT] Photo input found, attaching change event listener...');
            photoInput.addEventListener('change', function(e) {
                // Prevent any default behavior
                e.preventDefault();
                e.stopPropagation();
                
                if (this.files.length > 0) {
                    const file = this.files[0];
                    console.log('[CLIENT] ===== PHOTO INPUT CHANGE EVENT =====');
                    console.log('[CLIENT] Photo file selected:', file.name, file.size, file.type);
                    
                    // Validate file type
                    if (!file.type.match(/^image\/(jpeg|jpg|png)$/i)) {
                        alert('Nur JPG, JPEG und PNG Dateien sind erlaubt!');
                        this.value = '';
                        return;
                    }
                    
                    // Validate file size (4MB)
                    if (file.size > 4 * 1024 * 1024) {
                        alert('Die Datei ist zu groß. Maximal 4MB erlaubt.');
                        this.value = '';
                        return;
                    }
                    
                    // Submit form using FormData and fetch to ensure proper multipart encoding
                    const form = this.closest('form');
                    if (form) {
                        console.log('Submitting form for photo upload...');
                        console.log('Form action:', form.action);
                        console.log('Form method:', form.method);
                        console.log('File input name:', this.name);
                        console.log('File input files:', this.files.length);
                        
                        // Get the file FIRST before doing anything else
                        const fileToUpload = this.files[0];
                        if (!fileToUpload) {
                            console.error('[CLIENT] ERROR: No file selected!');
                            alert('Bitte wählen Sie ein Foto aus.');
                            return;
                        }
                        
                        console.log('[CLIENT] ===== PHOTO UPLOAD START =====');
                        console.log('[CLIENT] File details:', {
                            name: fileToUpload.name,
                            size: fileToUpload.size,
                            type: fileToUpload.type,
                            lastModified: fileToUpload.lastModified
                        });
                        console.log('[CLIENT] File input name:', this.name);
                        console.log('[CLIENT] File input id:', this.id);
                        
                        // Create FormData - add file FIRST and EXPLICITLY
                        const formData = new FormData();
                        
                        // STEP 1: Add the photo file FIRST with exact field name 'photo'
                        formData.append('photo', fileToUpload, fileToUpload.name);
                        console.log('[CLIENT] Step 1: Added photo file with field name "photo"');
                        
                        // STEP 2: Add all other form fields
                        const formInputs = form.querySelectorAll('input:not([type="file"]), textarea, select');
                        let fieldsAdded = 0;
                        formInputs.forEach(input => {
                            if (input.type === 'checkbox') {
                                if (input.checked && input.name) {
                                    formData.append(input.name, input.value || 'on');
                                    fieldsAdded++;
                                }
                            } else if (input.type === 'radio') {
                                if (input.checked && input.name) {
                                    formData.append(input.name, input.value);
                                    fieldsAdded++;
                                }
                            } else if (input.name && input.value !== '' && input.type !== 'file') {
                                formData.append(input.name, input.value);
                                fieldsAdded++;
                            }
                        });
                        console.log(`[CLIENT] Step 2: Added ${fieldsAdded} form fields`);
                        
                        // STEP 3: Verify file is in FormData
                        console.log('[CLIENT] Step 3: Verifying FormData contents...');
                        let fileCount = 0;
                        let photoFound = false;
                        for (let pair of formData.entries()) {
                            if (pair[1] instanceof File) {
                                fileCount++;
                                console.log(`  [FILE ${fileCount}] Field: "${pair[0]}", File: ${pair[1].name}, Size: ${pair[1].size} bytes`);
                                if (pair[0] === 'photo') {
                                    photoFound = true;
                                }
                            }
                        }
                        
                        console.log(`[CLIENT] FormData verification: ${fileCount} file(s) found, photo field: ${photoFound ? 'YES ✓' : 'NO ✗'}`);
                        
                        if (!photoFound) {
                            console.error('[CLIENT] CRITICAL: Photo file missing from FormData!');
                            alert('Fehler: Datei konnte nicht hinzugefügt werden. Bitte Seite neu laden und erneut versuchen.');
                            return;
                        }
                        
                        console.log('[CLIENT] ===== READY TO UPLOAD =====');
                        
                        // Add loading indicator
                        const submitBtn = form.querySelector('button[type="submit"]');
                        const originalBtnText = submitBtn ? submitBtn.textContent : '';
                        if (submitBtn) {
                            submitBtn.disabled = true;
                            submitBtn.textContent = 'Hochladen...';
                        }
                        
                        // Submit using fetch - DO NOT redirect/reload until upload completes
                        console.log('[CLIENT] ===== STARTING FETCH UPLOAD =====');
                        const startTime = Date.now();
                        
                        fetch(form.action, {
                            method: 'POST',
                            body: formData,
                            credentials: 'same-origin' // Include cookies for session
                        })
                        .then(async response => {
                            const elapsed = Date.now() - startTime;
                            console.log(`[CLIENT] ===== FETCH RESPONSE (${elapsed}ms) =====`);
                            console.log('[CLIENT] Response status:', response.status);
                            console.log('[CLIENT] Response statusText:', response.statusText);
                            console.log('[CLIENT] Response redirected:', response.redirected);
                            console.log('[CLIENT] Response ok:', response.ok);
                            console.log('[CLIENT] Response type:', response.type);
                            console.log('[CLIENT] Response url:', response.url);
                            
                            // Wait 2 seconds before redirecting to ensure logs are visible
                            console.log('[CLIENT] Waiting 2 seconds before redirect to preserve console logs...');
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            
                            if (response.status === 302 || response.redirected) {
                                const redirectUrl = response.headers.get('Location') || response.url;
                                console.log('[CLIENT] Redirecting to:', redirectUrl);
                                window.location.href = redirectUrl;
                            } else if (response.ok) {
                                console.log('[CLIENT] Response OK - reloading page...');
                                window.location.reload();
                            } else {
                                const errorText = await response.text().catch(() => 'No details');
                                console.error('[CLIENT] Upload failed:', response.status, errorText);
                                alert('Fehler beim Hochladen: ' + response.statusText + '\n\nStatus: ' + response.status);
                                if (submitBtn) {
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = originalBtnText;
                                }
                            }
                        })
                        .catch(error => {
                            console.error('[CLIENT] ===== FETCH ERROR =====');
                            console.error('[CLIENT] Error type:', error.name);
                            console.error('[CLIENT] Error message:', error.message);
                            console.error('[CLIENT] Error stack:', error.stack);
                            alert('Fehler beim Hochladen: ' + error.message + '\n\nBitte Browser-Konsole öffnen (F12) für Details.');
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalBtnText;
                            }
                        });
                    } else {
                        console.error('Form not found!');
                        alert('Fehler: Formular nicht gefunden. Bitte Seite neu laden.');
                    }
                }
            });
            } else {
                console.error('[CLIENT] Photo input not found!');
            }
            
            // Automatisches Übermitteln des Formulars beim Hochladen von Ordinationsfotos
            console.log('[EDIT-PROFILE] Looking for gallery input...');
            console.log('[EDIT-PROFILE] Searching for element with id="galleryPhotos"');
            const galleryInput = document.getElementById('galleryPhotos');
            console.log('[EDIT-PROFILE] getElementById result:', galleryInput);
            
            // Also try querySelector
            const galleryInputQuery = document.querySelector('#galleryPhotos');
            console.log('[EDIT-PROFILE] querySelector result:', galleryInputQuery);
            
            // List all file inputs
            const allFileInputs = document.querySelectorAll('input[type="file"]');
            console.log('[EDIT-PROFILE] All file inputs found:', allFileInputs.length);
            allFileInputs.forEach((input, index) => {
                console.log(`[EDIT-PROFILE] File input ${index + 1}: id="${input.id}", name="${input.name}"`);
            });
            
            if (galleryInput) {
                console.log('[EDIT-PROFILE] ✓ Gallery input found! Attaching change event listener...');
            galleryInput.addEventListener('change', function(e) {
                // Prevent any default behavior
                e.preventDefault();
                e.stopPropagation();
                
                console.log('[CLIENT] ===== GALLERY INPUT CHANGE EVENT =====');
                console.log('[CLIENT] Files selected:', this.files.length);
                
                if (this.files.length > 0) {
                    console.log('[CLIENT] ===== GALLERY PHOTOS SELECTED =====');
                    console.log('[CLIENT] Gallery photos count:', this.files.length);
                    
                    // Validate each file
                    for (let i = 0; i < this.files.length; i++) {
                        const file = this.files[i];
                        console.log(`Gallery file ${i + 1}:`, file.name, file.size, file.type);
                        
                        // Validate file type
                        if (!file.type.match(/^image\/(jpeg|jpg|png)$/i)) {
                            alert(`Datei "${file.name}" ist kein gültiges Bildformat. Nur JPG, JPEG und PNG sind erlaubt.`);
                            this.value = '';
                            return;
                        }
                        
                        // Validate file size (4MB)
                        if (file.size > 4 * 1024 * 1024) {
                            alert(`Datei "${file.name}" ist zu groß. Maximal 4MB erlaubt.`);
                            this.value = '';
                            return;
                        }
                    }
                    
                    // Submit form using FormData and fetch
                    const form = this.closest('form');
                    if (form) {
                        console.log('[CLIENT] ===== GALLERY UPLOAD START =====');
                        console.log('[CLIENT] Form action:', form.action);
                        console.log('[CLIENT] Form method:', form.method);
                        console.log('[CLIENT] File input name:', this.name);
                        console.log('[CLIENT] File input id:', this.id);
                        console.log('[CLIENT] File input files:', this.files.length);
                        
                        // Get files FIRST before doing anything else
                        const filesToUpload = Array.from(this.files);
                        console.log('[CLIENT] Files to upload:', filesToUpload.map(f => ({
                            name: f.name,
                            size: f.size,
                            type: f.type
                        })));
                        
                        // Create FormData - add files FIRST and EXPLICITLY
                        const formData = new FormData();
                        
                        // STEP 1: Add gallery photo files FIRST with exact field name 'galleryPhotos'
                        filesToUpload.forEach((file, index) => {
                            formData.append('galleryPhotos', file, file.name);
                            console.log(`[CLIENT] Step 1: Added gallery photo ${index + 1} with field name "galleryPhotos"`);
                        });
                        
                        // STEP 2: Add all other form fields
                        const formInputs = form.querySelectorAll('input:not([type="file"]), textarea, select');
                        let fieldsAdded = 0;
                        formInputs.forEach(input => {
                            if (input.type === 'checkbox') {
                                if (input.checked && input.name) {
                                    formData.append(input.name, input.value || 'on');
                                    fieldsAdded++;
                                }
                            } else if (input.type === 'radio') {
                                if (input.checked && input.name) {
                                    formData.append(input.name, input.value);
                                    fieldsAdded++;
                                }
                            } else if (input.name && input.value !== '' && input.type !== 'file') {
                                formData.append(input.name, input.value);
                                fieldsAdded++;
                            }
                        });
                        console.log(`[CLIENT] Step 2: Added ${fieldsAdded} form fields`);
                        
                        // STEP 3: Verify files are in FormData
                        console.log('[CLIENT] Step 3: Verifying FormData contents...');
                        let fileCount = 0;
                        let galleryFound = false;
                        for (let pair of formData.entries()) {
                            if (pair[1] instanceof File) {
                                fileCount++;
                                console.log(`  [FILE ${fileCount}] Field: "${pair[0]}", File: ${pair[1].name}, Size: ${pair[1].size} bytes`);
                                if (pair[0] === 'galleryPhotos') {
                                    galleryFound = true;
                                }
                            }
                        }
                        
                        console.log(`[CLIENT] FormData verification: ${fileCount} file(s) found, galleryPhotos field: ${galleryFound ? 'YES ✓' : 'NO ✗'}`);
                        
                        if (!galleryFound || fileCount === 0) {
                            console.error('[CLIENT] CRITICAL: Gallery photos missing from FormData!');
                            alert('Fehler: Fotos konnten nicht hinzugefügt werden. Bitte Seite neu laden und erneut versuchen.');
                            return;
                        }
                        
                        console.log('[CLIENT] ===== READY TO UPLOAD GALLERY =====');
                        
                        // Add loading indicator
                        const submitBtn = form.querySelector('button[type="submit"]');
                        const originalBtnText = submitBtn ? submitBtn.textContent : '';
                        if (submitBtn) {
                            submitBtn.disabled = true;
                            submitBtn.textContent = 'Hochladen...';
                        }
                        
                        // Submit using fetch - DO NOT redirect/reload until upload completes
                        console.log('[CLIENT] ===== STARTING GALLERY FETCH UPLOAD =====');
                        const startTime = Date.now();
                        
                        fetch(form.action, {
                            method: 'POST',
                            body: formData,
                            credentials: 'same-origin' // Include cookies for session
                        })
                        .then(async response => {
                            const elapsed = Date.now() - startTime;
                            console.log(`[CLIENT] ===== GALLERY FETCH RESPONSE (${elapsed}ms) =====`);
                            console.log('[CLIENT] Response status:', response.status);
                            console.log('[CLIENT] Response statusText:', response.statusText);
                            console.log('[CLIENT] Response redirected:', response.redirected);
                            console.log('[CLIENT] Response ok:', response.ok);
                            console.log('[CLIENT] Response type:', response.type);
                            console.log('[CLIENT] Response url:', response.url);
                            
                            // Wait 2 seconds before redirecting
                            console.log('[CLIENT] Waiting 2 seconds before redirect to preserve console logs...');
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            
                            if (response.status === 302 || response.redirected) {
                                const redirectUrl = response.headers.get('Location') || response.url;
                                console.log('[CLIENT] Redirecting to:', redirectUrl);
                                window.location.href = redirectUrl;
                            } else if (response.ok) {
                                console.log('[CLIENT] Response OK - reloading page...');
                                window.location.reload();
                            } else {
                                const errorText = await response.text().catch(() => 'No details');
                                console.error('[CLIENT] Gallery upload failed:', response.status, errorText);
                                alert('Fehler beim Hochladen: ' + response.statusText + '\n\nStatus: ' + response.status);
                                if (submitBtn) {
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = originalBtnText;
                                }
                            }
                        })
                        .catch(error => {
                            console.error('[CLIENT] ===== GALLERY FETCH ERROR =====');
                            console.error('[CLIENT] Error type:', error.name);
                            console.error('[CLIENT] Error message:', error.message);
                            console.error('[CLIENT] Error stack:', error.stack);
                            alert('Fehler beim Hochladen: ' + error.message + '\n\nBitte Browser-Konsole öffnen (F12) für Details.');
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalBtnText;
                            }
                        });
                    } else {
                        console.error('[CLIENT] Form not found!');
                        alert('Fehler: Formular nicht gefunden. Bitte Seite neu laden.');
                    }
                } else {
                    console.error('[CLIENT] No files selected in gallery input!');
                }
            });
                console.log('[CLIENT] Gallery input event listener attached successfully');
            } else {
                console.error('[CLIENT] Gallery photos input element not found!');
                console.error('[CLIENT] Available inputs:', Array.from(document.querySelectorAll('input[type="file"]')).map(i => ({id: i.id, name: i.name})));
            }
            
            console.log('[CLIENT] All form handlers initialized');
        }); // End DOMContentLoaded
        
        // API nachladen
        let retryCount = 0;
        const maxRetries = 2;
        
        // Define a safe global callback to avoid errors if script loads with callback
        window.initAutocomplete = function initAutocomplete() {
            // No-op on this page; fields are manual here
        };

        function loadGoogleMapsAPI() {
            const script = document.createElement('script');
            // Verwende den vom Server gesendeten API-Schlüssel
            const apiKey = "<%= googleMapsApiKey %>";
            if (!apiKey || apiKey === '') {
                console.warn('Google Maps API key not set on edit page, skipping load');
                return;
            }
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initAutocomplete&v=weekly`;
            script.async = true;
            script.defer = true;
            
            script.onerror = function() {
                console.error('Fehler beim Laden der Google Maps API');
                if (retryCount < maxRetries) {
                    retryCount++;
                    console.log(`Versuche Google Maps API erneut zu laden (${retryCount}/${maxRetries})`);
                    setTimeout(loadGoogleMapsAPI, 1000);
                } else {
                    console.error('Maximale Anzahl von Versuchen erreicht');
                    gm_authFailure();
                }
            };
            
            document.head.appendChild(script);
        }
        
        loadGoogleMapsAPI();
    </script>
</body>
</html> 